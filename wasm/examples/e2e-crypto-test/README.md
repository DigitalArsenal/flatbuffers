# FlatBuffers Cross-Language Encryption E2E Tests

End-to-end testing framework for FlatBuffers WASM encryption module across multiple languages
with support for 10 major cryptocurrency key types.

## Overview

This test framework validates that:
1. FlatBuffers can be encrypted/decrypted consistently across all supported languages
2. Binary outputs from one language can be read and decrypted by another
3. Crypto operations (SHA-256, AES-256-CTR) produce identical results everywhere

## Supported Cryptocurrency Key Types

| # | Chain | Signature Scheme | Curve |
|---|-------|------------------|-------|
| 1 | Bitcoin | ECDSA | secp256k1 |
| 2 | Ethereum | ECDSA | secp256k1 |
| 3 | Solana | EdDSA | Ed25519 |
| 4 | SUI | EdDSA | Ed25519 |
| 5 | Cosmos | ECDSA | secp256k1 |
| 6 | Polkadot | Schnorr | Sr25519 |
| 7 | Cardano | EdDSA | Ed25519 |
| 8 | Tezos | EdDSA | Ed25519 |
| 9 | NEAR | EdDSA | Ed25519 |
| 10 | Aptos | EdDSA | Ed25519 |

## Test Runners

| Language | Runtime | Location |
|----------|---------|----------|
| Node.js | V8 (native) | `runners/node/` |
| Go | wazero | `runners/go/` |
| Python | wasmer-python | `runners/python/` |
| Rust | wasmer | `runners/rust/` |
| Java | Chicory | `runners/java/` |
| C# | Wasmtime | `runners/csharp/` |
| Swift | WasmKit | `runners/swift/` |

## Quick Start

### Prerequisites

1. Build the WASM encryption module:
```bash
cd /path/to/flatbuffers
cmake --build build/wasm --target flatc_wasm_wasi
```

2. Generate test vectors (run once):
```bash
cd wasm/examples/e2e-crypto-test
node generate_vectors.mjs
```

### Running Tests

**Node.js (reference implementation):**
```bash
cd runners/node
node test_runner.mjs
```

**Go:**
```bash
cd runners/go
go run test_runner.go
```

**Python:**
```bash
cd runners/python
pip install wasmer wasmer_compiler_cranelift
python test_runner.py
```

**Rust:**
```bash
cd runners/rust
cargo run
```

**Java:**
```bash
cd runners/java
mvn compile exec:java
```

**C#:**
```bash
cd runners/csharp
dotnet run
```

**Swift:**
```bash
cd runners/swift
swift run
```

## Test Structure

### Test Vectors

Located in `vectors/`:
- `encryption_keys.json` - AES keys and IVs for each chain
- `crypto_keys.json` - ECDH/signature keypairs for each chain
- `monster_data.json` - Sample Monster data for FlatBuffer tests
- `wallet_data.json` - Multi-chain wallet test data
- `test_vectors.json` - Combined test configuration

### Generated Binaries

The Node.js test runner generates binary files in `vectors/binary/`:
- `monster_unencrypted.bin` - Unencrypted FlatBuffer
- `monster_encrypted_bitcoin.bin` - Encrypted with Bitcoin key
- `monster_encrypted_ethereum.bin` - Encrypted with Ethereum key
- ... (one for each chain)

Other language runners read these files to verify cross-language compatibility.

## What Each Test Validates

### Test 1: SHA-256 Hash
Verifies SHA-256 produces identical output across all WASM runtimes:
- `SHA256("hello")` = `2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824`
- `SHA256("")` = `e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855`

### Test 2: Per-Chain Encryption
For each of the 10 chains:
1. Encrypt test data with chain-specific AES key
2. Verify encrypted data differs from plaintext
3. Decrypt and verify original data is restored

### Test 3: Cross-Language Verification
1. Read binary files generated by Node.js
2. Decrypt using same keys
3. Verify all languages can interoperate

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    Test Runner (any language)           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │   Test 1    │  │   Test 2    │  │   Test 3    │     │
│  │   SHA-256   │  │  Encrypt/   │  │ Cross-Lang  │     │
│  │             │  │  Decrypt    │  │   Verify    │     │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │
│         │                │                │             │
│         └────────────────┼────────────────┘             │
│                          │                              │
│                          ▼                              │
│         ┌────────────────────────────────┐             │
│         │     WASM Runtime Adapter       │             │
│         │  (wazero/wasmer/wasmtime/etc)  │             │
│         └────────────────┬───────────────┘             │
│                          │                              │
└──────────────────────────┼──────────────────────────────┘
                           │
                           ▼
            ┌──────────────────────────────┐
            │   flatc-encryption.wasm      │
            │   (Crypto++ compiled)        │
            │                              │
            │  • AES-256-CTR              │
            │  • SHA-256                   │
            │  • X25519 ECDH              │
            │  • secp256k1 ECDH/ECDSA     │
            │  • P-256 ECDH/ECDSA         │
            │  • Ed25519 Sign/Verify      │
            └──────────────────────────────┘
```

## Adding a New Language

1. Create a new directory under `runners/`
2. Implement WASM loading with your chosen runtime
3. Implement Emscripten `invoke_*` trampolines
4. Follow the test structure from existing runners
5. Run and verify against Node.js generated binaries

Key implementation details:
- All `invoke_*` functions must look up and call functions from the indirect table
- Exception handling stubs (`setThrew`, `__cxa_*`) can return dummy values
- WASI stubs for `random_get` and `clock_time_get` must be functional

## License

Apache 2.0 - Same as FlatBuffers
