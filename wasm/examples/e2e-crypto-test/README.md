# FlatBuffers Cross-Language Encryption E2E Tests

End-to-end testing framework for FlatBuffers WASM encryption module across multiple languages
with support for 10 major cryptocurrency key types.

## Transparent Encryption Model

**Key concept:** Encryption is TRANSPARENT. The same FlatBuffers schema works for both
encrypted and unencrypted messages. Encryption is applied to the serialized FlatBuffer
binary, not to specific fields in the schema.

```
┌──────────────┐      ┌─────────────────┐      ┌─────────────────┐
│  JSON Data   │  →   │  FlatBuffer     │  →   │  Encrypted      │
│              │      │  Binary         │      │  Binary         │
└──────────────┘      └─────────────────┘      └─────────────────┘
     Same schema for both encrypted and unencrypted
```

**How users identify encrypted messages:**
- File identifier (e.g., `"MONS"` vs `"MONE"`)
- A user-defined field in the message
- External metadata or protocol headers
- File extension or naming convention

## Schema Usage

This test framework uses the **upstream FlatBuffers test schemas** - no custom schemas:
- `tests/monster_test.fbs` - Standard Monster schema
- `tests/monsterdata_test.json` - Standard test data

## Supported Cryptocurrency Key Types

| # | Chain | Signature Scheme | Curve |
|---|-------|------------------|-------|
| 1 | Bitcoin | ECDSA | secp256k1 |
| 2 | Ethereum | ECDSA | secp256k1 |
| 3 | Solana | EdDSA | Ed25519 |
| 4 | SUI | EdDSA | Ed25519 |
| 5 | Cosmos | ECDSA | secp256k1 |
| 6 | Polkadot | Schnorr | Sr25519 |
| 7 | Cardano | EdDSA | Ed25519 |
| 8 | Tezos | EdDSA | Ed25519 |
| 9 | NEAR | EdDSA | Ed25519 |
| 10 | Aptos | EdDSA | Ed25519 |

## Test Runners

| Language | Runtime | Location |
|----------|---------|----------|
| Node.js | V8 (native) | `runners/node/` |
| Go | wazero | `runners/go/` |
| Python | wasmer-python | `runners/python/` |
| Rust | wasmer | `runners/rust/` |
| Java | Chicory | `runners/java/` |
| C# | Wasmtime | `runners/csharp/` |
| Swift | WasmKit | `runners/swift/` |

## Quick Start

### Prerequisites

1. Build the WASM encryption module:
```bash
cd /path/to/flatbuffers
cmake --build build/wasm --target flatc_wasm_wasi
```

2. Generate test vectors (run once):
```bash
cd wasm/examples/e2e-crypto-test
node generate_vectors.mjs
```

### Running Tests

**Node.js (reference implementation):**
```bash
cd runners/node
npm link flatc-wasm  # Link the WASM module
node test_runner.mjs
```

**Go:**
```bash
cd runners/go
go run test_runner.go
```

**Python:**
```bash
cd runners/python
pip install wasmer wasmer_compiler_cranelift
python test_runner.py
```

**Rust:**
```bash
cd runners/rust
cargo run
```

**Java:**
```bash
cd runners/java
mvn compile exec:java
```

**C#:**
```bash
cd runners/csharp
dotnet run
```

**Swift:**
```bash
cd runners/swift
swift run
```

## Test Structure

### Test Vectors

Located in `vectors/`:
- `encryption_keys.json` - AES-256 keys and IVs for each chain
- `crypto_keys.json` - ECDH/signature keypairs for each chain
- `test_vectors.json` - Test configuration pointing to upstream schemas

### Generated Binaries

The Node.js test runner generates binary files in `vectors/binary/`:
- `monster_unencrypted.bin` - Unencrypted FlatBuffer (using upstream schema)
- `monster_encrypted_bitcoin.bin` - Entire binary encrypted with Bitcoin key
- `monster_encrypted_ethereum.bin` - Entire binary encrypted with Ethereum key
- ... (one for each chain)

Other language runners read these files to verify cross-language compatibility.

## What Each Test Validates

### Test 1: SHA-256 Hash
Verifies SHA-256 produces identical output across all WASM runtimes:
- `SHA256("hello")` = `2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824`

### Test 2: Transparent Encryption
For each of the 10 chains:
1. Generate FlatBuffer binary from upstream schema/data
2. Encrypt **entire binary** with chain-specific AES key
3. Verify encrypted data differs from original
4. Decrypt entire binary
5. Verify decrypted binary matches original exactly
6. Parse decrypted data to verify it's valid

### Test 3: Cross-Language Verification
1. Read binary files generated by Node.js
2. Verify other languages can read/decrypt the same files
3. Confirm all languages interoperate

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    Test Runner (any language)           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │   Test 1    │  │   Test 2    │  │   Test 3    │     │
│  │   SHA-256   │  │ Transparent │  │ Cross-Lang  │     │
│  │             │  │ Encrypt     │  │   Verify    │     │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │
│         │                │                │             │
│         └────────────────┼────────────────┘             │
│                          │                              │
│                          ▼                              │
│         ┌────────────────────────────────┐             │
│         │     WASM Runtime Adapter       │             │
│         │  (wazero/wasmer/wasmtime/etc)  │             │
│         └────────────────┬───────────────┘             │
│                          │                              │
└──────────────────────────┼──────────────────────────────┘
                           │
                           ▼
            ┌──────────────────────────────┐
            │   flatc-encryption.wasm      │
            │   (Crypto++ compiled)        │
            │                              │
            │  • AES-256-CTR (encrypt)    │
            │  • SHA-256                   │
            │  • Ed25519 Sign/Verify      │
            │  • secp256k1 ECDH/ECDSA     │
            └──────────────────────────────┘
```

## Adding a New Language

1. Create a new directory under `runners/`
2. Implement WASM loading with your chosen runtime
3. Implement Emscripten `invoke_*` trampolines (call indirect function table)
4. Test SHA-256 and AES-256-CTR encrypt/decrypt
5. Verify against Node.js generated binaries

Key implementation details:
- All `invoke_*` functions must look up and call functions from the indirect table
- Exception handling stubs (`setThrew`, `__cxa_*`) can return dummy values
- WASI stubs for `random_get` and `clock_time_get` must be functional

## License

Apache 2.0 - Same as FlatBuffers
