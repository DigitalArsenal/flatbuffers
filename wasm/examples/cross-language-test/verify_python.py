#!/usr/bin/env python3
"""
Cross-language verification test for Python encryption implementation.

This script loads test vectors generated by the JavaScript implementation
and verifies that Python can correctly decrypt them.
"""

import json
import sys
import os

# Add the Python encryption module to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'python-encryption'))

from flatc_wasm import decrypt_buffer, EncryptionContext


def from_hex(hex_str: str) -> bytearray:
    """Convert hex string to bytearray."""
    return bytearray.fromhex(hex_str)


def to_hex(data: bytes) -> str:
    """Convert bytes to hex string."""
    return data.hex()


def run_verification():
    """Run verification tests against test vectors."""
    # Load test vectors
    vectors_path = os.path.join(os.path.dirname(__file__), 'test_vectors.json')
    with open(vectors_path, 'r') as f:
        test_data = json.load(f)

    key_hex = test_data['key_hex']
    key = bytes.fromhex(key_hex)
    ctx = EncryptionContext(key)

    print(f"Testing against flatc {test_data['flatc_version']}")
    print(f"Key: {key_hex[:16]}...")
    print()

    passed = 0
    failed = 0

    for vector in test_data['vectors']:
        name = vector['name']
        schema = vector['schema']
        root_type = vector['root_type']
        original_hex = vector['original_hex']
        encrypted_hex = vector['encrypted_hex']

        # Skip edge cases with empty/zero values where encryption is a no-op
        if original_hex == encrypted_hex:
            print(f"SKIP: {name} (no encrypted fields present)")
            continue

        # Test decryption: encrypted -> original
        encrypted_buffer = from_hex(encrypted_hex)
        decrypted_buffer = decrypt_buffer(bytes(encrypted_buffer), schema, ctx, root_type)
        decrypted_hex = to_hex(decrypted_buffer)

        if decrypted_hex == original_hex:
            print(f"PASS: {name}")
            passed += 1
        else:
            print(f"FAIL: {name}")
            print(f"  Expected: {original_hex[:80]}...")
            print(f"  Got:      {decrypted_hex[:80]}...")
            failed += 1

    print()
    print(f"Results: {passed} passed, {failed} failed")
    return failed == 0


if __name__ == '__main__':
    success = run_verification()
    sys.exit(0 if success else 1)
